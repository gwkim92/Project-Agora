services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-agora}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-agora}
      POSTGRES_DB: ${POSTGRES_DB:-agora}
    volumes:
      - pg_data:/var/lib/postgresql/data
    # Optional: bind to localhost for troubleshooting (psql/pgAdmin). Not required for operation.
    ports:
      - "127.0.0.1:${POSTGRES_PORT:-6543}:5432"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    # Optional: bind to localhost for troubleshooting. Not required for operation.
    ports:
      - "127.0.0.1:${REDIS_PORT:-6385}:6379"
    restart: unless-stopped

  api:
    build:
      context: ../..
      dockerfile: server/Dockerfile
    environment:
      # ---- Core ----
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://agora:agora@postgres:5432/agora}
      AGORA_BASE_URL: ${AGORA_BASE_URL}
      AGORA_CORS_ORIGINS: ${AGORA_CORS_ORIGINS}
      # ---- Auth ----
      AGORA_CHALLENGE_TTL_SECONDS: ${AGORA_CHALLENGE_TTL_SECONDS:-300}
      AGORA_ACCESS_TOKEN_TTL_SECONDS: ${AGORA_ACCESS_TOKEN_TTL_SECONDS:-86400}
      # ---- Rate limit ----
      AGORA_RATE_LIMIT_PER_MIN: ${AGORA_RATE_LIMIT_PER_MIN:-300}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      # ---- Optional: operator moderation ----
      AGORA_OPERATOR_ADDRESSES: ${AGORA_OPERATOR_ADDRESSES:-}
      # ---- Service stage ----
      AGORA_SERVICE_STAGE: ${AGORA_SERVICE_STAGE:-demo}
      # ---- Optional: onchain ----
      AGORA_ONCHAIN_STAKE_ENABLED: ${AGORA_ONCHAIN_STAKE_ENABLED:-0}
      AGORA_ONCHAIN_SYNC_ENABLED: ${AGORA_ONCHAIN_SYNC_ENABLED:-0}
      AGORA_RPC_URL: ${AGORA_RPC_URL:-}
      AGORA_STAKE_CONTRACT_ADDRESS: ${AGORA_STAKE_CONTRACT_ADDRESS:-0x0000000000000000000000000000000000000000}
      AGORA_CHAIN_ID: ${AGORA_CHAIN_ID:-84532}
      AGORA_NETWORK: ${AGORA_NETWORK:-base}
      AGORA_USDC_ADDRESS: ${AGORA_USDC_ADDRESS:-0x0000000000000000000000000000000000000000}
      AGORA_TREASURY_CONTRACT_ADDRESS: ${AGORA_TREASURY_CONTRACT_ADDRESS:-0x0000000000000000000000000000000000000000}
      # ---- Optional: anchoring ----
      AGORA_ANCHORING_ENABLED: ${AGORA_ANCHORING_ENABLED:-0}
      AGORA_ANCHOR_REGISTRY_CONTRACT_ADDRESS: ${AGORA_ANCHOR_REGISTRY_CONTRACT_ADDRESS:-0x0000000000000000000000000000000000000000}
      AGORA_ANCHORING_EOA_PRIVATE_KEY: ${AGORA_ANCHORING_EOA_PRIVATE_KEY:-}
    ports:
      - "127.0.0.1:8000:8000"
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    environment:
      CADDY_EMAIL: ${CADDY_EMAIL}
      AGORA_API_DOMAIN: ${AGORA_API_DOMAIN}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - api
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
  pg_data:
  redis_data:

